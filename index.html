<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Search System</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Scanner JS -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; max-width: 600px; margin: 0 auto; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-search { background: #007bff; color: white; }
        .btn-scan { background: #28a745; color: white; width: 100%; margin-top: 10px; }
        
        #reader { width: 100%; margin-top: 15px; display: none; border: 1px solid #ccc; }
        
        .result { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .item-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; gap: 10px; }
        .item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; background: #eee; }
        .item-info { flex: 1; }
        .balance { font-weight: bold; }
        .low { color: red; }
        .ok { color: green; }
        .error { color: red; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¦ Stock Search</h2>

    <div class="search-box">
        <input type="text" id="barcodeInput" placeholder="Enter Barcode..." onkeypress="handleEnter(event)">
        <button class="btn-search" onclick="searchBarcode()">Search</button>
    </div>

    <button class="btn-scan" onclick="toggleScan()">ðŸ“· Scan with Camera</button>
    
    <div id="reader"></div>

    <div id="results" class="result">
        <p style="text-align: center; color: #777;">Waiting for search...</p>
    </div>
</div>

<script>
    // --- CREDENTIALS ---
    const SUPABASE_URL = 'https://modywlizhthghxoxehoj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Yuj4wrOXwOMVwyz41Vs8IA_FkgpO6WJ';
    const TABLE_NAME = 'stock_inventory';

    // --- GLOBAL VARIABLES ---
    let supabase;
    let html5QrCode;
    let isScanning = false;

    // --- INITIALIZATION ---
    // We check if supabase is already defined to avoid "already declared" errors on refresh
    window.onload = function() {
        if (typeof supabase === 'undefined') {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("âœ… Supabase Initialized");
            } catch (e) {
                alert("Error: " + e.message);
            }
        }
    };

    // --- SEARCH FUNCTION ---
    async function searchBarcode() {
        const input = document.getElementById('barcodeInput').value.trim();
        const resultsDiv = document.getElementById('results');

        if (!input) {
            resultsDiv.innerHTML = '<p class="error">Please enter a barcode</p>';
            return;
        }

        resultsDiv.innerHTML = '<p style="text-align:center;">Searching...</p>';

        try {
            // Query Database
            const { data, error } = await supabase
                .from(TABLE_NAME)
                .select('*')
                .eq('barcode', input);

            if (error) {
                console.error(error);
                resultsDiv.innerHTML = `<p class="error">Database Error: ${error.message}</p>`;
                return;
            }

            if (!data || data.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align:center; color:#777;">No item found.</p>';
                return;
            }

            // Render Results
            let html = '';
            data.forEach(item => {
                // Balance Logic
                let balColor = item.balance > 0 ? 'ok' : 'low';
                // Image Logic
                let imgUrl = item.image_link || `https://picsum.photos/seed/${item.barcode}/60/60`;

                html += `
                <div class="item-card">
                    <img src="${imgUrl}" class="item-img">
                    <div class="item-info">
                        <div><strong>${item.name}</strong></div>
                        <div style="font-size: 0.9em; color: #555;">
                            Style: ${item.style_code} | Size: ${item.size} | Color: ${item.colour}
                        </div>
                        <div class="balance ${balColor}">Stock: ${item.balance}</div>
                    </div>
                </div>`;
            });

            resultsDiv.innerHTML = html;

        } catch (err) {
            console.error(err);
            resultsDiv.innerHTML = `<p class="error">System Error: ${err.message}</p>`;
        }
    }

    function handleEnter(e) {
        if (e.key === 'Enter') searchBarcode();
    }

    // --- SCANNER FUNCTION ---
    async function toggleScan() {
        const readerDiv = document.getElementById('reader');
        const scanBtn = document.querySelector('.btn-scan');

        if (isScanning) {
            // Stop Scanner
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    isScanning = false;
                    readerDiv.style.display = 'none';
                    scanBtn.innerText = "ðŸ“· Scan with Camera";
                }).catch(err => console.error(err));
            }
        } else {
            // Start Scanner
            // Check HTTPS requirement
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert("Camera requires HTTPS or Localhost to work.");
                return;
            }

            try {
                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start(
                    { facingMode: "environment" }, // Back camera
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess
                );
                isScanning = true;
                readerDiv.style.display = 'block';
                scanBtn.innerText = "Stop Camera";
            } catch (err) {
                alert("Failed to start camera: " + err);
            }
        }
    }

    function onScanSuccess(decodedText) {
        // Stop scanning automatically
        toggleScan();
        // Fill input
        document.getElementById('barcodeInput').value = decodedText;
        // Trigger search
        searchBarcode();
    }

</script>

</body>
</html>
