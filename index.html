<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Search System</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Scanner JS -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; max-width: 600px; margin: 0 auto; }
        .container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        h2 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .search-box { display: flex; gap: 10px; margin-bottom: 15px; }
        input { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
        
        button { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .btn-search { background: #007bff; color: white; }
        .btn-scan { background: #28a745; color: white; width: 100%; margin-top: 10px; }
        
        #reader { width: 100%; margin-top: 15px; display: none; border: 1px solid #ccc; }
        
        .result { border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px; }
        .item-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; margin-bottom: 10px; display: flex; gap: 10px; }
        .item-img { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; background: #eee; }
        .item-info { flex: 1; }
        .balance { font-weight: bold; }
        .low { color: red; }
        .ok { color: green; }
        .error { color: red; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ðŸ“¦ Stock Search</h2>

    <div class="search-box">
        <input type="text" id="barcodeInput" placeholder="Enter Barcode..." onkeypress="handleEnter(event)">
        <button class="btn-search" onclick="searchBarcode()">Search</button>
    </div>

    <button class="btn-scan" onclick="toggleScan()">ðŸ“· Scan with Camera</button>
    
    <div id="reader"></div>

    <div id="results" class="result">
        <p style="text-align: center; color: #777;">Waiting for search...</p>
    </div>
</div>

<script>
    // --- CREDENTIALS ---
    const SUPABASE_URL = 'https://modywlizhthghxoxehoj.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_Yuj4wrOXwOMVwyz41Vs8IA_FkgpO6WJ';
    const TABLE_NAME = 'stock_inventory';

    // --- GLOBAL VARIABLES ---
    let supabase;
    let html5QrCode;
    let isScanning = false;

    // --- INITIALIZATION ---
    // We check if supabase is already defined to avoid "already declared" errors on refresh
    window.onload = function() {
        if (typeof supabase === 'undefined') {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("âœ… Supabase Initialized");
            } catch (e) {
                alert("Error: " + e.message);
            }
        }
    };

    // --- SEARCH FUNCTION ---
    async function searchBarcode() {
        const input = document.getElementById('barcodeInput').value.trim();
        const resultsDiv = document.getElementById('results');

        if (!input) {
            resultsDiv.innerHTML = '<p class="error">Please enter a barcode</p>';
            return;
        }

        resultsDiv.innerHTML = '<p style="text-align:center;">Searching...</p>';

        try {
            // Query Database
            const { data, error } = await supabase
                .from(TABLE_NAME)
                .select('*')
                .eq('barcode', input);

            if (error) {
                console.error(error);
                resultsDiv.innerHTML = `<p class="error">Database Error: ${error.message}</p>`;
                return;
            }

            if (!data || data.length === 0) {
                resultsDiv.innerHTML = '<p style="text-align:center; color:#777;">No item found.</p>';
                return;
            }

            // Render Results
            let html = '';
            data.forEach(item => {
                // Balance Logic
                let balColor = item.balance > 0 ? 'ok' : 'low';
                // Image Logic
                let imgUrl = item.image_link || `https://picsum.photos/seed/${item.barcode}/60/60`;

                html += `
                <div class="item-card">
                    <img src="${imgUrl}" class="item-img">
                    <div class="item-info">
                        <div><strong>${item.name}</strong></div>
                        <div style="font-size: 0.9em; color: #555;">
                            Style: ${item.style_code} | Size: ${item.size} | Color: ${item.colour}
                        </div>
                        <div class="balance ${balColor}">Stock: ${item.balance}</div>
                    </div>
                </div>`;
            });

            resultsDiv.innerHTML = html;

        } catch (err) {
            console.error(err);
            resultsDiv.innerHTML = `<p class="error">System Error: ${err.message}</p>`;
        }
    }

    function handleEnter(e) {
        if (e.key === 'Enter') searchBarcode();
    }

    // --- SCANNER FUNCTION ---
    async function toggleScan() {
        const readerDiv = document.getElementById('reader');
        const scanBtn = document.querySelector('.btn-scan');

        if (isScanning) {
            // Stop Scanner
            if (html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    isScanning = false;
                    readerDiv.style.display = 'none';
                    scanBtn.innerText = "ðŸ“· Scan with Camera";
                }).catch(err => console.error(err));
            }
        } else {
            // Start Scanner
            // Check HTTPS requirement
            if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                alert("Camera requires HTTPS or Localhost to work.");
                return;
            }

            try {
                html5QrCode = new Html5Qrcode("reader");
                await html5QrCode.start(
                    { facingMode: "environment" }, // Back camera
                    { fps: 10, qrbox: { width: 250, height: 250 } },
                    onScanSuccess
                );
                isScanning = true;
                readerDiv.style.display = 'block';
                scanBtn.innerText = "Stop Camera";
            } catch (err) {
                alert("Failed to start camera: " + err);
            }
        }
    }

    function onScanSuccess(decodedText) {
        // Stop scanning automatically
        toggleScan();
        // Fill input
        document.getElementById('barcodeInput').value = decodedText;
        // Trigger search
        searchBarcode();
    }

</script>

</body>
</html>            background: var(--surface);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .item-img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border);
            flex-shrink: 0;
        }

        .item-details { flex: 1; }
        
        .item-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; }
        .item-meta { font-size: 0.85rem; color: var(--text-light); margin-bottom: 6px; display: flex; gap: 10px; flex-wrap: wrap; }
        .badge { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

        .balance-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .bal-ok { background: #dcfce7; color: #166534; }
        .bal-low { background: #fee2e2; color: #991b1b; }

        .loading { text-align: center; padding: 2rem; color: var(--text-light); }
        .error { text-align: center; padding: 2rem; color: var(--danger); }
        .no-data { text-align: center; padding: 2rem; color: var(--text-light); }

        /* Mobile Specifics */
        @media (max-width: 600px) {
            .result-item { flex-direction: column; text-align: center; }
            .item-img { width: 120px; height: 120px; }
            .item-meta { justify-content: center; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Stock Search</h1>
        <p>Scan or search inventory</p>
    </header>

    <div class="card">
        <div class="tabs">
            <div class="tab active" id="tab-barcode" onclick="switchTab('barcode')">Barcode</div>
            <div class="tab" id="tab-style" onclick="switchTab('style')">Style Code</div>
        </div>

        <!-- Barcode Panel -->
        <div id="panel-barcode">
            <div class="input-group">
                <input type="text" id="barcode-input" placeholder="Enter or scan barcode...">
            </div>
            <button class="btn btn-primary" onclick="manualSearch()">Search Database</button>
            <button class="btn btn-scan" id="scan-btn" onclick="toggleScanner()">
                ðŸ“· Scan Barcode
            </button>
            <div id="reader"></div>
        </div>

        <!-- Style Code Panel -->
        <div id="panel-style" style="display: none;">
            <div class="input-group">
                <input type="text" id="style-input" placeholder="Enter style code (e.g. CTS-001)...">
            </div>
            <button class="btn btn-primary" onclick="styleSearch()">Search Style</button>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-area"></div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://modywlizhthghxoxehoj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Yuj4wrOXwOMVwyz41Vs8IA_FkgpO6WJ';
        const TABLE_NAME = 'stock_inventory';

        // --- INIT ---
        let supabase;
        let html5QrCode;
        let isScanning = false;

        window.addEventListener('DOMContentLoaded', () => {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("âœ… Supabase Connected");
            } catch (e) {
                document.getElementById('results-area').innerHTML = `<div class="error">Connection Failed: ${e.message}</div>`;
            }

            // Enter key listeners
            document.getElementById('barcode-input').addEventListener('keyup', (e) => {
                if(e.key === 'Enter') manualSearch();
            });
            document.getElementById('style-input').addEventListener('keyup', (e) => {
                if(e.key === 'Enter') styleSearch();
            });
        });

        // --- TABS ---
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.getElementById('panel-barcode').style.display = tab === 'barcode' ? 'block' : 'none';
            document.getElementById('panel-style').style.display = tab === 'style' ? 'block' : 'none';
            
            // Stop scanner if switching away
            if (isScanning && tab !== 'barcode') stopScanner();
            
            // Clear results
            document.getElementById('results-area').innerHTML = '';
        }

        // --- SEARCH LOGIC ---
        async function manualSearch() {
            const val = document.getElementById('barcode-input').value.trim();
            if (!val) return alert("Please enter a barcode");
            await fetchData('barcode', 'eq', val);
        }

        async function styleSearch() {
            const val = document.getElementById('style-input').value.trim();
            if (!val) return alert("Please enter a style code");
            // Partial match, case insensitive
            await fetchData('style_code', 'ilike', `%${val}%`);
        }

        async function fetchData(column, operator, value) {
            const area = document.getElementById('results-area');
            area.innerHTML = '<div class="loading">Searching database...</div>';

            try {
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    [operator](column, value); // Using bracket notation for dynamic operator (eq or ilike)

                area.innerHTML = ''; // Clear loading

                if (error) {
                    area.innerHTML = `<div class="error">Database Error: ${error.message}</div>`;
                    console.error(error);
                    return;
                }

                if (!data || data.length === 0) {
                    area.innerHTML = '<div class="no-data">No results found.</div>';
                    return;
                }

                // Render items
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    
                    // Determine Balance Color
                    const balClass = item.balance > 0 ? 'bal-ok' : 'bal-low';
                    // Fallback Image
                    const imgSrc = item.image_link || `https://picsum.photos/seed/${item.barcode}/150/150`;

                    div.innerHTML = `
                        <img src="${imgSrc}" class="item-img" onclick="window.open('${imgSrc}', '_blank')" alt="Product">
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-meta">
                                <span class="badge">${item.barcode}</span>
                                <span>Style: <strong>${item.style_code}</strong></span>
                            </div>
                            <div class="item-meta">
                                <span>Color: ${item.colour}</span>
                                <span>Size: ${item.size}</span>
                            </div>
                            <span class="balance-tag ${balClass}">Balance: ${item.balance}</span>
                        </div>
                    `;
                    area.appendChild(div);
                });

            } catch (err) {
                area.innerHTML = `<div class="error">System Error: ${err.message}</div>`;
            }
        }

        // --- SCANNER LOGIC ---
        async function toggleScanner() {
            const btn = document.getElementById('scan-btn');
            const readerDiv = document.getElementById('reader');

            if (isScanning) {
                stopScanner();
            } else {
                // Check HTTPS/Localhost requirement
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    alert("Camera access requires HTTPS or Localhost.");
                    return;
                }

                try {
                    html5QrCode = new Html5Qrcode("reader");
                    await html5QrCode.start(
                        { facingMode: "environment" }, 
                        { fps: 10, qrbox: { width: 250, height: 250 } }, 
                        onScanSuccess
                    );
                    isScanning = true;
                    btn.innerHTML = "â¹ Stop Camera";
                    btn.style.background = "#ef4444";
                    readerDiv.style.display = "block";
                } catch (err) {
                    alert("Could not start camera: " + err);
                }
            }
        }

        function stopScanner() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    isScanning = false;
                    const btn = document.getElementById('scan-btn');
                    const readerDiv = document.getElementById('reader');
                    btn.innerHTML = "ðŸ“· Scan Barcode";
                    btn.style.background = "#1e293b";
                    readerDiv.style.display = "none";
                }).catch(err => console.error(err));
            }
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            const input = document.getElementById('barcode-input');
            input.value = decodedText;
            manualSearch(); // Auto search
        }
    </script>
</body>
</html>
