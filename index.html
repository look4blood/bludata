<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Stock Data Search System</title>
    
    <!-- Supabase JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Barcode Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --bg: #f1f5f9;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --danger: #ef4444;
            --success: #10b981;
            --radius: 12px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

        body {
            background-color: var(--bg);
            color: var(--text);
            padding: 1rem;
            padding-bottom: 80px; /* Space for mobile */
        }

        /* --- Header --- */
        header {
            text-align: center;
            margin-bottom: 1.5rem;
        }
        header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        header p { color: var(--text-light); font-size: 0.9rem; }

        /* --- Search Card --- */
        .card {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* --- Tabs --- */
        .tabs {
            display: flex;
            background: #e2e8f0;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            color: var(--text-light);
            transition: all 0.2s;
        }
        .tab.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* --- Inputs & Buttons --- */
        .input-group { margin-bottom: 1rem; }
        
        input[type="text"] {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus { border-color: var(--primary); }

        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-scan { background: var(--text); color: white; margin-top: 0.5rem; }
        .btn:active { opacity: 0.8; transform: scale(0.99); }

        /* --- Scanner --- */
        #reader { width: 100%; border-radius: var(--radius); overflow: hidden; margin-top: 1rem; display: none; }
        
        /* --- Results --- */
        .result-item {
            background: var(--surface);
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            border: 1px solid var(--border);
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .item-img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border);
            flex-shrink: 0;
        }

        .item-details { flex: 1; }
        
        .item-name { font-weight: 700; font-size: 1.1rem; margin-bottom: 4px; }
        .item-meta { font-size: 0.85rem; color: var(--text-light); margin-bottom: 6px; display: flex; gap: 10px; flex-wrap: wrap; }
        .badge { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace; }

        .balance-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .bal-ok { background: #dcfce7; color: #166534; }
        .bal-low { background: #fee2e2; color: #991b1b; }

        .loading { text-align: center; padding: 2rem; color: var(--text-light); }
        .error { text-align: center; padding: 2rem; color: var(--danger); }
        .no-data { text-align: center; padding: 2rem; color: var(--text-light); }

        /* Mobile Specifics */
        @media (max-width: 600px) {
            .result-item { flex-direction: column; text-align: center; }
            .item-img { width: 120px; height: 120px; }
            .item-meta { justify-content: center; }
        }
    </style>
</head>
<body>

    <header>
        <h1>Stock Search</h1>
        <p>Scan or search inventory</p>
    </header>

    <div class="card">
        <div class="tabs">
            <div class="tab active" id="tab-barcode" onclick="switchTab('barcode')">Barcode</div>
            <div class="tab" id="tab-style" onclick="switchTab('style')">Style Code</div>
        </div>

        <!-- Barcode Panel -->
        <div id="panel-barcode">
            <div class="input-group">
                <input type="text" id="barcode-input" placeholder="Enter or scan barcode...">
            </div>
            <button class="btn btn-primary" onclick="manualSearch()">Search Database</button>
            <button class="btn btn-scan" id="scan-btn" onclick="toggleScanner()">
                ðŸ“· Scan Barcode
            </button>
            <div id="reader"></div>
        </div>

        <!-- Style Code Panel -->
        <div id="panel-style" style="display: none;">
            <div class="input-group">
                <input type="text" id="style-input" placeholder="Enter style code (e.g. CTS-001)...">
            </div>
            <button class="btn btn-primary" onclick="styleSearch()">Search Style</button>
        </div>
    </div>

    <!-- Results Area -->
    <div id="results-area"></div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://modywlizhthghxoxehoj.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_Yuj4wrOXwOMVwyz41Vs8IA_FkgpO6WJ';
        const TABLE_NAME = 'stock_inventory';

        // --- INIT ---
        let supabase;
        let html5QrCode;
        let isScanning = false;

        window.addEventListener('DOMContentLoaded', () => {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log("âœ… Supabase Connected");
            } catch (e) {
                document.getElementById('results-area').innerHTML = `<div class="error">Connection Failed: ${e.message}</div>`;
            }

            // Enter key listeners
            document.getElementById('barcode-input').addEventListener('keyup', (e) => {
                if(e.key === 'Enter') manualSearch();
            });
            document.getElementById('style-input').addEventListener('keyup', (e) => {
                if(e.key === 'Enter') styleSearch();
            });
        });

        // --- TABS ---
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            document.getElementById('panel-barcode').style.display = tab === 'barcode' ? 'block' : 'none';
            document.getElementById('panel-style').style.display = tab === 'style' ? 'block' : 'none';
            
            // Stop scanner if switching away
            if (isScanning && tab !== 'barcode') stopScanner();
            
            // Clear results
            document.getElementById('results-area').innerHTML = '';
        }

        // --- SEARCH LOGIC ---
        async function manualSearch() {
            const val = document.getElementById('barcode-input').value.trim();
            if (!val) return alert("Please enter a barcode");
            await fetchData('barcode', 'eq', val);
        }

        async function styleSearch() {
            const val = document.getElementById('style-input').value.trim();
            if (!val) return alert("Please enter a style code");
            // Partial match, case insensitive
            await fetchData('style_code', 'ilike', `%${val}%`);
        }

        async function fetchData(column, operator, value) {
            const area = document.getElementById('results-area');
            area.innerHTML = '<div class="loading">Searching database...</div>';

            try {
                const { data, error } = await supabase
                    .from(TABLE_NAME)
                    .select('*')
                    [operator](column, value); // Using bracket notation for dynamic operator (eq or ilike)

                area.innerHTML = ''; // Clear loading

                if (error) {
                    area.innerHTML = `<div class="error">Database Error: ${error.message}</div>`;
                    console.error(error);
                    return;
                }

                if (!data || data.length === 0) {
                    area.innerHTML = '<div class="no-data">No results found.</div>';
                    return;
                }

                // Render items
                data.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    
                    // Determine Balance Color
                    const balClass = item.balance > 0 ? 'bal-ok' : 'bal-low';
                    // Fallback Image
                    const imgSrc = item.image_link || `https://picsum.photos/seed/${item.barcode}/150/150`;

                    div.innerHTML = `
                        <img src="${imgSrc}" class="item-img" onclick="window.open('${imgSrc}', '_blank')" alt="Product">
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-meta">
                                <span class="badge">${item.barcode}</span>
                                <span>Style: <strong>${item.style_code}</strong></span>
                            </div>
                            <div class="item-meta">
                                <span>Color: ${item.colour}</span>
                                <span>Size: ${item.size}</span>
                            </div>
                            <span class="balance-tag ${balClass}">Balance: ${item.balance}</span>
                        </div>
                    `;
                    area.appendChild(div);
                });

            } catch (err) {
                area.innerHTML = `<div class="error">System Error: ${err.message}</div>`;
            }
        }

        // --- SCANNER LOGIC ---
        async function toggleScanner() {
            const btn = document.getElementById('scan-btn');
            const readerDiv = document.getElementById('reader');

            if (isScanning) {
                stopScanner();
            } else {
                // Check HTTPS/Localhost requirement
                if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
                    alert("Camera access requires HTTPS or Localhost.");
                    return;
                }

                try {
                    html5QrCode = new Html5Qrcode("reader");
                    await html5QrCode.start(
                        { facingMode: "environment" }, 
                        { fps: 10, qrbox: { width: 250, height: 250 } }, 
                        onScanSuccess
                    );
                    isScanning = true;
                    btn.innerHTML = "â¹ Stop Camera";
                    btn.style.background = "#ef4444";
                    readerDiv.style.display = "block";
                } catch (err) {
                    alert("Could not start camera: " + err);
                }
            }
        }

        function stopScanner() {
            if (html5QrCode && isScanning) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    isScanning = false;
                    const btn = document.getElementById('scan-btn');
                    const readerDiv = document.getElementById('reader');
                    btn.innerHTML = "ðŸ“· Scan Barcode";
                    btn.style.background = "#1e293b";
                    readerDiv.style.display = "none";
                }).catch(err => console.error(err));
            }
        }

        function onScanSuccess(decodedText) {
            stopScanner();
            const input = document.getElementById('barcode-input');
            input.value = decodedText;
            manualSearch(); // Auto search
        }
    </script>
</body>
</html>
